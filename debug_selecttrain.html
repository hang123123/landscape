<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•SelectTrainæµç¨‹</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #4f9cf9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #3b82f6;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SelectTrain æµç¨‹è°ƒè¯•</h1>
        
        <div class="test-section">
            <h3>æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="testSelectTrainFlow()">æ¨¡æ‹ŸselectTrainæ‰§è¡Œ</button>
            <button onclick="testDataProcessing()">æµ‹è¯•æ•°æ®å¤„ç†</button>
            <button onclick="testDisplayFunctions()">æµ‹è¯•æ˜¾ç¤ºå‡½æ•°</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h3>æ‰§è¡ŒçŠ¶æ€</h3>
            <div id="status" class="status loading">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
        
        <div class="test-section">
            <h3>æ¨¡æ‹Ÿæ˜¾ç¤ºåŒºåŸŸ</h3>
            <div id="routeResults" style="background: #333; padding: 20px; border-radius: 8px; min-height: 200px;">
                <!-- è¿™é‡Œæ¨¡æ‹Ÿä¸»é¡µé¢çš„routeResultsåŒºåŸŸ -->
            </div>
        </div>
        
        <div class="test-section">
            <h3>è¯¦ç»†æ—¥å¿—</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (type === 'error') {
                console.error(message);
            } else if (type === 'warn') {
                console.warn(message);
            } else {
                console.log(message);
            }
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        function updateStatus(message, type = 'loading') {
            const element = document.getElementById('status');
            element.className = `status ${type}`;
            element.textContent = message;
        }
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨
        async function mockApiCall(url, data) {
            log(`æ¨¡æ‹ŸAPIè°ƒç”¨: ${url}`);
            log(`è¯·æ±‚æ•°æ®: ${JSON.stringify(data)}`);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }
            
            const result = await response.json();
            log(`APIå“åº”: ${JSON.stringify(result, null, 2)}`);
            return result;
        }
        
        // å¤åˆ¶ä¸»é¡µé¢çš„displayRouteResultså‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function displayRouteResults(routeData, train) {
            log('å¼€å§‹æ‰§è¡ŒdisplayRouteResults...');
            const routeResults = document.getElementById('routeResults');
            
            try {
                // åˆ›å»ºè·¯çº¿ä¿¡æ¯å±•ç¤ºå®¹å™¨
                const routeInfoContainer = document.createElement('div');
                routeInfoContainer.style.background = '#444';
                routeInfoContainer.style.padding = '20px';
                routeInfoContainer.style.borderRadius = '8px';
                routeInfoContainer.style.marginBottom = '20px';
                
                // Route Header
                if (routeData.route_info) {
                    log('å¤„ç†è·¯çº¿ä¿¡æ¯å¤´éƒ¨...');
                    const routeHeader = document.createElement('div');
                    routeHeader.innerHTML = `
                        <div style="text-align: center; color: white;">
                            <h2>${routeData.route_info.train_no}</h2>
                            <p>${routeData.route_info.from_station} â†’ ${routeData.route_info.to_station}</p>
                            <p>é¢„è®¡è¡Œç¨‹ï¼š${routeData.route_info.travel_time}</p>
                        </div>
                    `;
                    routeResults.appendChild(routeHeader);
                    log('è·¯çº¿ä¿¡æ¯å¤´éƒ¨æ·»åŠ å®Œæˆ');
                }
                
                // Attractions
                if (routeData.attractions && routeData.attractions.length > 0) {
                    log(`å¤„ç†${routeData.attractions.length}ä¸ªæ™¯ç‚¹ä¿¡æ¯...`);
                    routeData.attractions.forEach((attraction, index) => {
                        log(`å¤„ç†æ™¯ç‚¹ ${index + 1}: ${attraction.city}`);
                        
                        const attractionCard = document.createElement('div');
                        attractionCard.style.background = '#555';
                        attractionCard.style.padding = '15px';
                        attractionCard.style.margin = '10px 0';
                        attractionCard.style.borderRadius = '8px';
                        attractionCard.style.color = 'white';
                        
                        attractionCard.innerHTML = `
                            <h3>${attraction.city}</h3>
                            <p>${attraction.description}</p>
                            <div>
                                <h4>æ™¯ç‚¹:</h4>
                                ${attraction.scenic_spots.map(spot => `<span style="background:#666;padding:2px 8px;margin:2px;border-radius:4px;display:inline-block;">${spot.name || spot}</span>`).join('')}
                            </div>
                            <div>
                                <h4>ç¾é£Ÿ:</h4>
                                ${attraction.local_food.map(food => `<span style="background:#777;padding:2px 8px;margin:2px;border-radius:4px;display:inline-block;">${food.name || food}</span>`).join('')}
                            </div>
                        `;
                        
                        routeResults.appendChild(attractionCard);
                        log(`æ™¯ç‚¹ ${attraction.city} æ·»åŠ å®Œæˆ`);
                    });
                    log('æ‰€æœ‰æ™¯ç‚¹ä¿¡æ¯å¤„ç†å®Œæˆ');
                }
                
                // Travel Tips
                if (routeData.travel_tips && routeData.travel_tips.length > 0) {
                    log(`å¤„ç†${routeData.travel_tips.length}ä¸ªæ—…è¡Œè´´å£«...`);
                    const tipsContainer = document.createElement('div');
                    tipsContainer.style.background = '#444';
                    tipsContainer.style.padding = '15px';
                    tipsContainer.style.borderRadius = '8px';
                    tipsContainer.style.color = 'white';
                    tipsContainer.innerHTML = `
                        <h4>æ—…è¡Œè´´å£«:</h4>
                        ${routeData.travel_tips.map((tip, index) => `<p>${index + 1}. ${tip}</p>`).join('')}
                    `;
                    routeResults.appendChild(tipsContainer);
                    log('æ—…è¡Œè´´å£«æ·»åŠ å®Œæˆ');
                }
                
                log('displayRouteResultsæ‰§è¡Œå®Œæˆ âœ…');
                
            } catch (error) {
                log(`displayRouteResultsæ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // å¤åˆ¶ä¸»é¡µé¢çš„displayRouteMapå‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰  
        async function displayRouteMap(stationsData) {
            log('å¼€å§‹æ‰§è¡ŒdisplayRouteMap...');
            const routeResults = document.getElementById('routeResults');
            
            try {
                // æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„åœ°å›¾å®¹å™¨
                const existingMapContainer = document.querySelector('#route-results-map-container');
                if (existingMapContainer) {
                    existingMapContainer.remove();
                    log('æ¸…ç†äº†ä¹‹å‰çš„åœ°å›¾å®¹å™¨');
                }
                
                // åœ¨è·¯çº¿ç»“æœå¼€å¤´æ’å…¥åœ°å›¾å®¹å™¨
                const mapContainer = document.createElement('div');
                mapContainer.id = 'route-results-map-container';
                mapContainer.style.background = '#555';
                mapContainer.style.padding = '20px';
                mapContainer.style.borderRadius = '8px';
                mapContainer.style.marginBottom = '20px';
                mapContainer.style.color = 'white';
                mapContainer.innerHTML = `
                    <h4>ğŸ—ºï¸ è¡Œç¨‹è·¯çº¿</h4>
                    <div style="background: #666; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #4f9cf9;">${stationsData.train_info?.train_no || 'N/A'}</div>
                                <div>è½¦æ¬¡</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stationsData.train_info?.total_distance || 'N/A'}</div>
                                <div>æ€»é‡Œç¨‹</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${stationsData.train_info?.total_time || 'N/A'}</div>
                                <div>æ€»æ—¶é•¿</div>
                            </div>
                        </div>
                    </div>
                    <div id="route-map" style="height: 300px; background: #777; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ—ºï¸</div>
                            <p>åœ°å›¾åŠ è½½åŒºåŸŸï¼ˆæ¨¡æ‹Ÿï¼‰</p>
                            <p style="font-size: 12px;">ç«™ç‚¹æ•°é‡: ${stationsData.stations?.length || 0}</p>
                        </div>
                    </div>
                `;
                
                // å°†åœ°å›¾å®¹å™¨æ’å…¥åˆ°ç»“æœçš„å¼€å¤´
                routeResults.insertBefore(mapContainer, routeResults.firstChild);
                log('åœ°å›¾å®¹å™¨å·²æ’å…¥DOM');
                
                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                log('åœ°å›¾å®¹å™¨å·²æ’å…¥DOMï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
                log(`ç«™ç‚¹æ•°æ®: ${JSON.stringify(stationsData, null, 2)}`);
                
                // æ¨¡æ‹Ÿåœ°å›¾åˆå§‹åŒ–å»¶è¿Ÿ
                setTimeout(() => {
                    log('æ¨¡æ‹Ÿåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
                    updateStatus('åœ°å›¾æ˜¾ç¤ºå®Œæˆ', 'success');
                }, 200);
                
                log('displayRouteMapæ‰§è¡Œå®Œæˆ âœ…');
                
            } catch (error) {
                log(`displayRouteMapæ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // æ¨¡æ‹Ÿå®Œæ•´çš„selectTrainæµç¨‹
        async function testSelectTrainFlow() {
            log('=== å¼€å§‹æ¨¡æ‹ŸselectTrainæµç¨‹ ===');
            clearRoutResults();
            updateStatus('æ­£åœ¨æ‰§è¡ŒselectTrainæµç¨‹...', 'loading');
            
            // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', function(e) {
                log(`JavaScripté”™è¯¯: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            });
            
            window.addEventListener('unhandledrejection', function(e) {
                log(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${e.reason}`, 'error');
            });
            
            // æ¨¡æ‹Ÿè½¦æ¬¡æ•°æ®
            const mockTrain = {
                train_number: "G8266",
                train_type: "é«˜é€ŸåŠ¨è½¦",
                departure_time: "08:00",
                arrival_time: "12:00",
                duration: "4å°æ—¶",
                price: "Â¥234"
            };
            
            // æ¨¡æ‹Ÿè¡¨å•æ•°æ®
            const mockFormData = {
                origin: "ä¸Šæµ·",
                destination: "å®¿è¿"
            };
            
            try {
                log('1. æ¨¡æ‹Ÿæ˜¾ç¤ºåŠ è½½çŠ¶æ€...');
                const routeResults = document.getElementById('routeResults');
                routeResults.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #4f9cf9;">
                        <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
                        <h3>æ­£åœ¨æŸ¥è¯¢è·¯çº¿ä¿¡æ¯...</h3>
                        <p>AIæ­£åœ¨ä¸ºæ‚¨è§„åˆ’æœ€ä½³æ—…è¡Œè·¯çº¿</p>
                    </div>
                `;
                
                log('2. å¼€å§‹è·å–è·¯çº¿é£æ™¯ä¿¡æ¯...');
                const routeResult = await mockApiCall('/api/get-route-info', {
                    train_number: mockTrain.train_number,
                    origin: mockFormData.origin,
                    destination: mockFormData.destination
                });
                log('è·¯çº¿ä¿¡æ¯è·å–å®Œæˆ âœ…');
                
                log('3. å¼€å§‹è·å–ç«™ç‚¹ä¿¡æ¯...');
                const stationsResult = await mockApiCall('/api/get-route-stations', {
                    train_number: mockTrain.train_number,
                    origin: mockFormData.origin,
                    destination: mockFormData.destination
                });
                log('ç«™ç‚¹ä¿¡æ¯è·å–å®Œæˆ âœ…');
                
                if (routeResult.success && stationsResult.success) {
                    log('4. å¼€å§‹æ˜¾ç¤ºè·¯çº¿ç»“æœ...');
                    clearRoutResults();
                    
                    // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°å®Œæˆ
                    setTimeout(() => {
                        displayRouteResults(routeResult.data, mockTrain);
                        log('è·¯çº¿ç»“æœæ˜¾ç¤ºå®Œæˆ âœ…');
                        
                        log('5. å¼€å§‹æ˜¾ç¤ºåœ°å›¾...');
                        displayRouteMap(stationsResult.data).then(() => {
                            log('åœ°å›¾æ˜¾ç¤ºå®Œæˆ âœ…');
                            log('=== selectTrainæµç¨‹å…¨éƒ¨å®Œæˆ âœ… ===');
                            updateStatus('å…¨éƒ¨æµç¨‹æ‰§è¡ŒæˆåŠŸ', 'success');
                        }).catch(error => {
                            log(`åœ°å›¾æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
                            updateStatus(`åœ°å›¾æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
                        });
                    }, 50);
                } else {
                    throw new Error(routeResult.message || stationsResult.message || 'è·å–æ•°æ®å¤±è´¥');
                }
                
            } catch (error) {
                log(`selectTrainæµç¨‹å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                
                const routeResults = document.getElementById('routeResults');
                routeResults.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                        <h3>è·å–è·¯çº¿ä¿¡æ¯å¤±è´¥</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function clearRoutResults() {
            document.getElementById('routeResults').innerHTML = '';
        }
        
        async function testDataProcessing() {
            log('=== æµ‹è¯•æ•°æ®å¤„ç† ===');
            updateStatus('æµ‹è¯•æ•°æ®å¤„ç†ä¸­...', 'loading');
            
            try {
                const routeResult = await mockApiCall('/api/get-route-info', {
                    train_number: "G8266",
                    origin: "ä¸Šæµ·", 
                    destination: "å®¿è¿"
                });
                
                const stationsResult = await mockApiCall('/api/get-route-stations', {
                    train_number: "G8266",
                    origin: "ä¸Šæµ·",
                    destination: "å®¿è¿"
                });
                
                log('æ•°æ®æ ¼å¼éªŒè¯:');
                log(`- routeResult.success: ${routeResult.success}`);
                log(`- stationsResult.success: ${stationsResult.success}`);
                log(`- attractionsæ•°é‡: ${routeResult.data.attractions?.length || 0}`);
                log(`- stationsæ•°é‡: ${stationsResult.data.stations?.length || 0}`);
                
                updateStatus('æ•°æ®å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`æ•°æ®å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`æ•°æ®å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDisplayFunctions() {
            log('=== æµ‹è¯•æ˜¾ç¤ºå‡½æ•° ===');
            updateStatus('æµ‹è¯•æ˜¾ç¤ºå‡½æ•°ä¸­...', 'loading');
            
            try {
                // è·å–æµ‹è¯•æ•°æ®
                const routeResult = await mockApiCall('/api/get-route-info', {
                    train_number: "G8266",
                    origin: "ä¸Šæµ·",
                    destination: "å®¿è¿"
                });
                
                const stationsResult = await mockApiCall('/api/get-route-stations', {
                    train_number: "G8266", 
                    origin: "ä¸Šæµ·",
                    destination: "å®¿è¿"
                });
                
                clearRoutResults();
                
                log('æµ‹è¯•displayRouteResults...');
                displayRouteResults(routeResult.data, {train_type: "é«˜é€ŸåŠ¨è½¦"});
                
                log('æµ‹è¯•displayRouteMap...');
                await displayRouteMap(stationsResult.data);
                
                log('æ˜¾ç¤ºå‡½æ•°æµ‹è¯•å®Œæˆ âœ…');
                updateStatus('æ˜¾ç¤ºå‡½æ•°æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`æ˜¾ç¤ºå‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`æ˜¾ç¤ºå‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹
        document.addEventListener('DOMContentLoaded', () => {
            log('è°ƒè¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
            updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>
</html> 